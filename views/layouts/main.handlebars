<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Terminal</title>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-title" content="Recipe App"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
          integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
          crossorigin="anonymous"/>
    <script src="/assets/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.4.6/fuse.min.js"
            integrity="sha512-FwWaT/y9ajd/+J06KL9Fko1jELonJNHMUTR4nGP9MSIq4ZdU2w9/OiLxn16p/zEOZkryHi3wKYsnWPuADD328Q=="
            crossorigin="anonymous"></script>
    <script>
        const functions ={{{functionsMeta}}}
        $(window).bind('beforeunload', function () {
            setTimeout(() => {
                $('#loadingPanel').show()
            }, 100)
        });

        const keyShortcuts = []

        function registerKeyNumber(number, callback) {
            keyShortcuts[number] = callback
        }

    </script>
</head>
<body style="background-color: black;-webkit-app-region: drag">
<div id="main" style="margin: 10px 50px 0 50px;">
    <div class="loadingContainer" id="loadingPanel">
        <h5>Loading...</h5>
    </div>
    <div style="border-radius: 0" class="row">
        <div>
            <div class="fixed-header" style="background: black; z-index: 1000;">
<!--                <div style="background: whitesmoke; height: 30px; z-index: 8000 !important;">-->
<!--                    <i style="float: right; font-size: 30px;" class="fa fa-times"></i>-->
<!--                </div>-->
                <div class="ui-titlebar">
                    <!--<div class="ui-titleicon"></div>-->
                    <div class="ui-titletext">Dashboard</div>
                    <div class="ui-titlecontrols">
                        <button class="ui-btn minimize">
                            <svg x="0px" y="0px" viewBox="0 0 10.2 1"><rect x="0" y="50%" width="10.2" height="1" /></svg>
                        </button><button class="ui-btn maximize">
                        <svg viewBox="0 0 10 10"><path d="M0,0v10h10V0H0z M9,9H1V1h8V9z" /></svg>
                    </button><button class="ui-btn close" onclick="window.close()">
                        <svg viewBox="0 0 10 10"><polygon points="10.2,0.7 9.5,0 5.1,4.4 0.7,0 0,0.7 4.4,5.1 0,9.5 0.7,10.2 5.1,5.8 9.5,10.2 10.2,9.5 5.8,5.1" /></svg>
                    </button>
                    </div>
                </div>
                <style>

                    .ui-titlebar {
                        display: flex;
                        width: 100%;
                        height: 20px;
                        background: #323232;
                        user-select: none;
                        cursor: pointer;
                        -webkit-app-region: drag;
                    }
                    .ui-titleicon {
                        flex-grow: 1;
                        max-width: 32px;
                        max-height: 32px;
                    }
                    .ui-titletext {
                        flex-grow: 2;
                        max-height: 20px;
                        width: auto;
                        font: 12px/20px "Segoe UI", Arial, sans-serif;
                        color: #fff;
                        text-indent: 10px;
                        padding-left: 10px;
                    }
                    .ui-titlecontrols {
                        max-width: 114px;
                        max-height: 32px;
                        flex-grow: 1;
                    }
                    .ui-btn {
                        margin: 0;
                        width: 38px;
                        height:20px;
                        border: 0;
                        outline: 0;
                        background: transparent;
                    }
                    .ui-btn:hover {
                        background: rgba(255,255,255,.1);
                    }
                    .ui-btn.close:hover {
                        background: #e81123;
                    }
                    .ui-btn svg path,
                    .ui-btn svg rect,
                    .ui-btn svg polygon {
                        fill: #fff;
                    }
                    .ui-btn svg {
                        width: 10px;
                        height: 10px;
                    }
                </style>
                <div style="margin-top: 10px; margin-left: 50px; margin-right: 50px">
                    <i onclick="window.history.back()" style="color:white; cursor: pointer; padding-bottom: 10px"
                       class="fa fa-arrow-left"></i>
                    <i style="color:white; cursor: pointer; margin-bottom: 10px; float: right"
                       class="fa fa-cog" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                       id="settingsDropdown"></i>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="settingsDropdown">
                        <div class="dropdown-item">
                            Zoom:
                            <div onclick="modifyZoom(-0.1)" style="font-family: monospace"
                                 class="btn btn-warning btn-sm">-
                            </div>
                            <span id="zoomSize" style="padding-left: 5px; padding-right: 5px">100%</span>
                            <div onclick="modifyZoom(0.1)" style="font-family: monospace"
                                 class="btn btn-warning btn-sm">+
                            </div>
                        </div>
                    </div>
                    <br/>
                    <div id="panelInputContainer" class="focusedPanelContainer" onclick="focusInput()">
                        <img src="/assets/caret-right.png"
                             style="height: 20px; width: 5px; padding: 0; opacity: 0.7; margin:0; margin-bottom: 8px"/>
                        <span id="panelTextInput" contenteditable="true"></span>
                        <button id="caret" for="panelTextInput">&nbsp;</button>
                    </div>
                    <div id="panelResults"
                         style="color: white; background: rgb(242, 165, 71); width: calc(100% - 100px); position: fixed; z-index: 5000">
                    </div>
                </div>
            </div>
            <div id="panelBody" style="height: calc(100vh - 100px); width: 100%;">
                <div id="zoomedBody">
                    {{{body}}}
                </div>
            </div>
            <script>
                let zoomFactor = 1.0

                function modifyZoom(factor) {
                    if (zoomFactor + factor > 0) {
                        zoomFactor += factor;
                        document.getElementById("zoomedBody").style.zoom = (zoomFactor * 100) + "%"
                        if (Math.round(zoomFactor * 100) < 100) {
                            $('#zoomSize').html("<span>&nbsp;</span>" + Math.round(zoomFactor * 100) + "%")
                        } else {
                            $('#zoomSize').html(Math.round(zoomFactor * 100) + "%")
                        }
                    }
                }

                const input = document.getElementById('panelTextInput');
                const caret = document.getElementById('caret');

                input.focus()

                function focusInput() {
                    $('#panelResults').show()
                    $('#panelInputContainer').addClass('focusedPanelContainer')
                    input.focus()
                }

                input.addEventListener('blur', (e) => {
                    $('#panelResults').hide()
                    $('#panelInputContainer').removeClass('focusedPanelContainer')
                });

                function isNumeric(str) {
                    return !isNaN(str) && !isNaN(parseFloat(str))
                }

                let panelInput = document.getElementById("panelTextInput");
                panelInput.addEventListener('input', function () {
                    const searchInput = $('#panelTextInput').html()
                    if (!isNumeric(searchInput)) {
                        updateSearch(searchInput)
                    }
                });

                document.addEventListener('keydown', function (e) {
                    if (e.target.tagName === "BODY") {
                        focusInput()
                    }
                    if (e.key === 'Enter' && e.target.id === 'panelTextInput') {
                        e.preventDefault()
                    }
                });

                document.addEventListener('keyup', function (e) {
                    if (e.key === 'Enter' && e.target.id === 'panelTextInput') {
                        let functionInput = $('#panelTextInput').html().split("&nbsp;").join(" ");
                        $('#panelTextInput').html('')
                        if (isNumeric(functionInput)) {
                            keyShortcuts[parseInt(functionInput)]()
                            return;
                        }
                        const args = functionInput.toUpperCase().split(" ")
                        $('#panelResults').html('')
                        if (args.length > 0) {
                            let chosenFunction = args.shift();
                            location.href = `/panel/${chosenFunction}?q=${encodeURIComponent(args)}`
                        }
                    }
                });


                const fuse = new Fuse(functions, {
                    keys: ['command', 'metadata.description']
                })

                function updateSearch(searchString) {
                    $('#panelResults').html('')
                    fuse.search(searchString.split(" ")[0]).slice(0, 5).forEach(x => {
                        $('#panelResults').append(`<span style="margin-left: 10px; padding: 0">
                    <a style="text-decoration: none; color: white" href="/panel/${x.command}">
                        <b>${x.command}</b> (${x.metadata.description})
                    </a>
                </span><br/>`)
                        if (x.metadata.commands) {
                            x.metadata.commands.forEach(command => {
                                $('#panelResults').append(`<span style="margin-left: 30px; padding: 0"><b>${command.syntax}</b> (${command.description})</span><br/>`)
                            })
                        }
                    })
                }

                $('.dropdown-menu').on('click', function (e) {
                    e.stopPropagation();
                });
            </script>
        </div>
        <style>
            * {
                font-family: 'Ubuntu', sans-serif;
            }

            .form-select, .form-control {
                background: orange !important;
                border-radius: 0 !important;
                border: none !important;
                padding-left: 5px !important;
                font-size: 16px;
            }
        </style>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8"
        crossorigin="anonymous"></script>
</body>
</html>
